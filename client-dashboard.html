<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Dashboard — Maltese First Capital</title>
  <link rel="icon" href="/assets/logo-crest.png">
  <link rel="stylesheet" href="/styles.css" />
  <style>
    :root { --bg:#0b0f16; --card:#101722; --text:#e9eef8; --muted:#9eb0c7; --gold:#d4af37; --ok:#1db954; }
    html,body{background:var(--bg);color:var(--text);margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,sans-serif}
    .wrap{max-width:1160px;margin:0 auto;padding:20px}
    .nav{display:flex;align-items:center;gap:16px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,.08)}
    .brand{display:flex;align-items:center;gap:10px;color:var(--text);text-decoration:none}
    .brand img{width:36px;height:36px;border-radius:8px;object-fit:contain;background:#0d131b}
    .brand b{letter-spacing:.3px}
    .logout{margin-left:auto}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
    @media (min-width:980px){ .grid{grid-template-columns:1.1fr .9fr} }
    .card{background:var(--card);border:1px solid rgba(212,175,55,.18);border-radius:16px;padding:18px}
    .k{color:var(--muted);font-size:13px}
    .v{font-weight:600}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;background:#0d131b}
    .pill.ok{border-color:#224b36}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{color:var(--muted);font-weight:600}
    .amt{white-space:nowrap}
    .pos{color:#9bf3b3} .neg{color:#ff9d9d}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="/index.html"><img src="/assets/logo-crest.png" alt=""><b>Maltese First Capital</b></a>
      <a class="logout" href="#" id="logoutLink">Logout</a>
    </div>

    <div class="grid">
      <!-- Left: Account overview -->
      <section class="card">
        <h2 style="margin:0 0 10px">Account Overview</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
          <div>
            <div class="k">Account Holder</div>
            <div class="v" id="holderName">—</div>
          </div>
          <div>
            <div class="k">Authorised Person</div>
            <div class="v" id="authPerson">—</div>
          </div>
          <div>
            <div class="k">Account Number</div>
            <div class="v mono" id="acctNo">—</div>
          </div>
          <div>
            <div class="k">Status</div>
            <div class="pill ok" id="acctStatus">Active</div>
          </div>
          <div>
            <div class="k">Currency</div>
            <div class="v" id="acctCcy">USD</div>
          </div>
          <div>
            <div class="k">Current Balance</div>
            <div class="v" id="acctBal">—</div>
          </div>
        </div>
      </section>

      <!-- Right: Transactions -->
      <section class="card">
        <h2 style="margin:0 0 10px">Recent Transactions</h2>
        <div id="txBox">
          <div class="k">Loading…</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Config FIRST -->
  <script>
    window.__MFC_CONFIG = { API_BASE_URL: 'https://maltese-first-capital-deluxe-backend.onrender.com' };
  </script>

  <!-- Wire -->
  <script>
    (()=>{
      const API = (window.__MFC_CONFIG?.API_BASE_URL||'').replace(/\/+$/,'');
      const $  = (s,r=document)=>r.querySelector(s);
      const fmtMoney = (n,c='USD') => (typeof n==='number' ? n.toLocaleString(undefined,{style:'currency',currency:c}) : '—');

      async function fetchJSON(url, opt){ const r = await fetch(url,opt); const t = await r.text(); try{return {ok:r.ok, data: t?JSON.parse(t):{}}}catch{return {ok:r.ok, data:{}, raw:t}} }

      function renderTx(lines, ccy){
        if (!Array.isArray(lines) || !lines.length) return '<div class="k">No transactions yet.</div>';
        const rows = lines
          .slice() // copy
          .sort((a,b)=>new Date(b.ts)-new Date(a.ts))
          .slice(0,20)
          .map(l=>{
            const sign = l.type === 'debit' ? -1 : 1;
            const cls  = sign < 0 ? 'neg' : 'pos';
            const amt  = fmtMoney(sign * Number(l.amount||0), l.currency || ccy || 'USD');
            const when = l.ts ? new Date(l.ts).toLocaleString() : '—';
            return `<tr>
              <td>${when}</td>
              <td>${l.description || l.type || '-'}</td>
              <td class="amt ${cls}">${amt}</td>
            </tr>`;
          }).join('');
        return `<table><thead><tr><th>Date</th><th>Description</th><th>Amount</th></tr></thead><tbody>${rows}</tbody></table>`;
      }

      async function boot(){
        const token = localStorage.mfc_token;
        if(!API || !token){ location.href='/client-login.html'; return; }

        // Who am I (for fallback display)
        const meReq = await fetchJSON(API + '/api/auth/me', { headers:{ Authorization:'Bearer '+token }});
        const me = meReq.ok ? meReq.data.user : null;

        // Overview (holder + authorisedPerson + accounts)
        const ovReq = await fetchJSON(API + '/api/client/overview', { headers:{ Authorization:'Bearer '+token }});
        if(!ovReq.ok){ localStorage.removeItem('mfc_token'); location.href='/client-login.html'; return; }
        const ov = ovReq.data || {};
        const acct = (ov.accounts && ov.accounts[0]) || null;

        $('#holderName').textContent = ov.holder || me?.name || '—';
        $('#authPerson').textContent = ov.authorisedPerson || (me?.email?.split('@')[0] || '—').replace(/[._-]+/g,' ').replace(/\b\w/g,c=>c.toUpperCase());

        if (acct){
          $('#acctNo').textContent  = acct.accountNo || '—';
          $('#acctStatus').textContent = (acct.status || 'active');
          $('#acctCcy').textContent = acct.currency || 'USD';
          $('#acctBal').textContent = fmtMoney(Number(acct.balance||0), acct.currency || 'USD');

          $('#txBox').innerHTML = renderTx(acct.lines || [], acct.currency);
        } else {
          $('#txBox').innerHTML = '<div class="k">No account found.</div>';
        }
      }

      document.addEventListener('DOMContentLoaded', boot);
      document.getElementById('logoutLink').addEventListener('click',(e)=>{e.preventDefault(); localStorage.removeItem('mfc_token'); location.href='/client-login.html';});
    })();
  </script>
</body>
</html>
