// scripts/account-open-wire.js
(() => {
  const CFG = (window.__MF_CONFIG || {});
  const API = CFG.API_BASE_URL || "";      // same-origin if empty
  const SITE_KEY = CFG.TURNSTILE_SITE_KEY || "";

  function loadTurnstile(){
    return new Promise((resolve) => {
      if (window.turnstile) return resolve(window.turnstile);
      const s = document.createElement('script');
      s.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js';
      s.async = true; s.defer = true;
      s.onload = () => resolve(window.turnstile || null);
      document.head.appendChild(s);
    });
  }

  async function getToken(hostEl){
    if (!SITE_KEY) return "";
    await loadTurnstile();
    return new Promise((res) => {
      const div = document.createElement('div');
      div.style.cssText = 'position:absolute;width:0;height:0;overflow:hidden;';
      (hostEl || document.body).appendChild(div);
      const wid = window.turnstile.render(div, { sitekey: SITE_KEY, size: 'invisible', callback: (t) => res(t) });
      try { window.turnstile.execute(wid); } catch { res(""); }
    });
  }

  function pickForm(){
    // Prefer the form that contains the "Submit Application" button
    const btn = document.getElementById('submitBtn');
    const f = btn?.closest('form');
    if (f) return f;
    // Fallback to first form on the page
    return document.querySelector('form');
  }

  function attach(){
    const form = pickForm();
    if (!form) return;
    if (form.dataset.mfcWired === '1') return; // idempotent
    form.dataset.mfcWired = '1';

    const MAX = 16 * 1024 * 1024; // 16 MB
    const OK = new Set(['application/pdf','image/jpeg','image/png','image/webp']);
    const badFile = () => {
      const inputs = form.querySelectorAll('input[type="file"]');
      for (const inp of inputs) for (const f of (inp.files || [])) {
        if (!OK.has(f.type) || f.size > MAX) return true;
      }
      return false;
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      // Avoid other handlers double-submitting
      e.stopPropagation();
      e.stopImmediatePropagation();

      try {
        if (badFile()) return alert('Use PDF/JPG/PNG/WEBP, max 16MB each.');

        // Build FormData exactly as-is (no DOM changes)
        const fd = new FormData(form);

        // Invisible Turnstile token (server will verify)
        const token = await getToken(form);
        if (token) {
          fd.append('cf_turnstile_response', token);
          fd.append('cf-turnstile-response', token); // support both parsers
        }

        const url = `${API}/api/onboarding/account-open`.replace(/([^:]\/)\/+/g, '$1');
        const res = await fetch(url, { method: 'POST', body: fd });
        const text = await res.text();
        let data; try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }

        if (!res.ok) throw new Error(data?.error || `Submit failed (${res.status})`);

        alert(`Application received. Reference: ${data.applicationId || data.id || 'OK'}`);
        try { form.reset(); } catch {}
      } catch (err) {
        alert(err.message || 'Submit failed');
      }
    }, { capture: true }); // capture to run before any bubbling listeners
  }

  (document.readyState === 'loading') ? document.addEventListener('DOMContentLoaded', attach) : attach();
})();
