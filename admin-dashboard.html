<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel – Maltese First Capital</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="site-header">
  <nav class="nav">
    <a href="index.html" class="brand"><img src="assets/logo.png" alt=""> <span class="wordmark">Maltese First Capital</span></a>
    <div class="nav-actions">
      <a href="#" id="logout">Log out</a>
    </div>
  </nav>
</header>

<main class="page">
  <h1>Admin Panel</h1>

  <div class="section">
    <h2>Add Transaction</h2>
    <form id="txForm" class="contact-form">
      <label>User ID</label>
      <input id="userId" required />
      <label>Currency</label>
      <select id="currency"><option>USD</option><option>EUR</option><option>GBP</option></select>
      <label>Amount</label>
      <input id="amount" type="number" step="0.01" required />
      <label>Type</label>
      <select id="type"><option value="credit">credit</option><option value="debit">debit</option></select>
      <label>Description</label>
      <input id="description" />
      <button class="btn-primary" type="submit">Add Transaction</button>
    </form>
    <div id="txMsg" style="margin-top:8px;"></div>
  </div>

  <div class="section">
    <h2>Edit Statement (Balance)</h2>
    <form id="balForm" class="contact-form">
      <label>User ID</label>
      <input id="balUserId" required />
      <label>Balance</label>
      <input id="newBalance" type="number" step="0.01" required />
      <label>Currency</label>
      <select id="balCurrency"><option>USD</option><option>EUR</option><option>GBP</option></select>
      <button class="btn-secondary" type="submit">Update Balance</button>
    </form>
    <div id="balMsg" style="margin-top:8px;"></div>
  </div>

  <div class="section">
    <h2>Replace Transaction History</h2>
    <p>Paste JSON array of transactions for a specific user.</p>
    <form id="histForm" class="contact-form">
      <label>User ID</label>
      <input id="histUserId" required />
      <label>Transactions JSON</label>
      <textarea id="histJson" rows="6" placeholder='[{"date":"2025-01-01","description":"Init","type":"credit","amount":1000,"currency":"USD"}]' required></textarea>
      <button class="btn-outline" type="submit">Replace History</button>
    </form>
    <div id="histMsg" style="margin-top:8px;"></div>
  </div>
</main>

<footer><p>© 2025 Maltese First Capital · Valletta, Malta</p></footer>

<script>
  const API = localStorage.getItem('BACKEND_URL') || 'https://maltese-first-capital-deluxe-backend.onrender.com';
  const TOKEN = localStorage.getItem('MFC_TOKEN');
  const ROLE  = localStorage.getItem('MFC_ROLE');

  if(!TOKEN || ROLE!=='admin'){ location.href='admin-login.html'; }

  document.getElementById('logout').addEventListener('click', (e)=>{
    e.preventDefault();
    localStorage.removeItem('MFC_TOKEN'); localStorage.removeItem('MFC_ROLE');
    location.href='index.html';
  });

  // Add transaction
  document.getElementById('txForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const txMsg = document.getElementById('txMsg');
    txMsg.textContent = 'Submitting…';
    try{
      const payload = {
        userId: document.getElementById('userId').value.trim(),
        currency: document.getElementById('currency').value,
        amount: parseFloat(document.getElementById('amount').value),
        type: document.getElementById('type').value,
        description: document.getElementById('description').value.trim()
      };
      const r = await fetch(`${API}/api/admin/tx`, {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${TOKEN}`},
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(data.message || 'Failed to add transaction');
      txMsg.style.color='#104a72'; txMsg.textContent='Transaction added.';
      e.target.reset();
    }catch(err){
      txMsg.style.color='#b00020'; txMsg.textContent = err.message;
    }
  });

  // Update balance/statement
  document.getElementById('balForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const balMsg = document.getElementById('balMsg');
    balMsg.textContent = 'Updating…';
    try{
      const userId = document.getElementById('balUserId').value.trim();
      const payload = {
        balance: parseFloat(document.getElementById('newBalance').value),
        currency: document.getElementById('balCurrency').value
      };
      const r = await fetch(`${API}/api/admin/statement/${encodeURIComponent(userId)}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${TOKEN}`},
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(data.message || 'Failed to update statement');
      balMsg.style.color='#104a72'; balMsg.textContent='Statement updated.';
      e.target.reset();
    }catch(err){
      balMsg.style.color='#b00020'; balMsg.textContent = err.message;
    }
  });

  // Replace transaction history
  document.getElementById('histForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const histMsg = document.getElementById('histMsg');
    histMsg.textContent = 'Replacing…';
    try{
      const userId = document.getElementById('histUserId').value.trim();
      let txs;
      try{ txs = JSON.parse(document.getElementById('histJson').value); }
      catch{ throw new Error('Invalid JSON'); }
      const r = await fetch(`${API}/api/admin/transactions/${encodeURIComponent(userId)}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${TOKEN}`},
        body: JSON.stringify({ transactions: txs })
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(data.message || 'Failed to replace history');
      histMsg.style.color='#104a72'; histMsg.textContent='History replaced.';
      e.target.reset();
    }catch(err){
      histMsg.style.color='#b00020'; histMsg.textContent = err.message;
    }
  });
</script>
</body>
</html>
