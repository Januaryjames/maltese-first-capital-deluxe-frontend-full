<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Change Password — Maltese First Capital</title>
  <link rel="icon" href="/assets/logo-crest.png" />
  <link rel="stylesheet" href="/styles.css" />

  <style>
    :root { --bg:#0b0f16; --panel:#0f1621; --text:#0f172a; --muted:#4d5a6b; --gold:#d4af37; }
    html,body{ background:#0b0f16; color:#e9eef8; margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,sans-serif; }
    .cl-wrap{ max-width:1060px; margin:0 auto; padding:16px 20px 48px; }

    .client-header{ background:#fff; color:#111; border-bottom:1px solid #e8edf3; padding:14px 20px; }
    .client-header .brand{ display:inline-flex; align-items:center; gap:10px; text-decoration:none; }
    .client-header .brand b{ color:#111; font-weight:600; letter-spacing:.2px; }
    .client-header .brand-logo{ width:48px; height:48px; object-fit:contain; display:inline-block; background:transparent; }
    .client-header .tag{ float:right; color:#475569; font-size:14px; margin-top:10px; }

    .cl-card{ max-width:560px; margin:56px auto 0; background:#fff; color:#111; border:1px solid #e8edf3; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:20px 22px 24px; }
    .cl-title{ font-size:26px; font-weight:800; margin:4px 0 4px; color:#0f172a; }
    .cl-sub{ color:#4d5a6b; margin:0 0 14px; line-height:1.45; }

    .cl-msg{ display:none; margin:0 0 12px; padding:10px 12px; border-radius:10px; font-size:14px; }
    .cl-msg.err{ display:block; background:#ffe9ea; color:#8a1820; border:1px solid #ffd0d4; }
    .cl-msg.ok{ display:block; background:#e7f7ee; color:#0c5132; border:1px solid #bfe4d0; }

    .cl-field{ margin:12px 0; }
    .cl-label{ display:block; font-size:13px; color:#334155; margin:0 0 6px; }
    .cl-input{ width:100%; height:44px; border-radius:12px; border:1px solid #e5e7eb; padding:0 12px; font-size:15px; background:#fff; color:#111; outline:none; }
    .cl-input:focus{ border-color:#c5a741; box-shadow:0 0 0 3px rgba(212,175,55,.25); }

    .cl-inline{ display:flex; align-items:center; gap:10px; margin:4px 0 12px; color:#475569; }
    .cl-btn{ width:100%; height:44px; border-radius:12px; border:0; cursor:pointer; background:linear-gradient(180deg, #e4c96b, #b98f28); color:#111; font-weight:700; }
    .cl-btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .cl-foot{ margin-top:10px; font-size:14px; color:#4d5a6b; }
    .cl-foot a{ color:#1d4ed8; text-decoration:none; }
  </style>

  <!-- Same mock-store loader & fallback used on login/dashboard -->
  <script>
    (function(){
      window.__MFC_STORE_READY = new Promise(function(resolve){
        let done=false; const complete=()=>{ if(!done){done=true; resolve();} };
        const s=document.createElement('script');
        s.src='/scripts/mock-store.js?v=1'; s.async=false;
        s.onload=complete;
        s.onerror=function(){
          console.warn('[MFC] mock-store.js failed; using empty store.');
          window.MFC_MOCK = { USERS:{}, ACCOUNTS:{} };
          complete();
        };
        document.head.appendChild(s);
      });
    })();
  </script>
</head>
<body>
  <header class="client-header">
    <div class="cl-wrap" style="padding-bottom:0">
      <a class="brand" href="/index.html">
        <img class="brand-logo" src="/assets/logo-crest.png" alt="Maltese First Capital" />
        <b>Maltese First Capital</b>
      </a>
      <span class="tag">Client Area</span>
    </div>
  </header>

  <main class="cl-wrap">
    <section class="cl-card">
      <h1 class="cl-title">Change Password</h1>
      <p class="cl-sub">Update your password for your Maltese First Capital client access.</p>

      <div id="msg" class="cl-msg"></div>

      <form id="cpForm" novalidate autocomplete="off">
        <div class="cl-field">
          <label class="cl-label" for="email">Email</label>
          <input id="email" class="cl-input" type="email"
                 autocomplete="off" autocapitalize="off" spellcheck="false" required />
        </div>

        <div class="cl-field">
          <label class="cl-label" for="current">Current password</label>
          <input id="current" class="cl-input" type="password"
                 autocomplete="current-password" spellcheck="false" required />
        </div>

        <div class="cl-field">
          <label class="cl-label" for="next">New password</label>
          <input id="next" class="cl-input" type="password"
                 autocomplete="new-password" spellcheck="false" required />
        </div>

        <div class="cl-field">
          <label class="cl-label" for="confirm">Confirm new password</label>
          <input id="confirm" class="cl-input" type="password"
                 autocomplete="new-password" spellcheck="false" required />
        </div>

        <div class="cl-inline">
          <input id="show" type="checkbox" />
          <label for="show">Show passwords</label>
        </div>

        <button id="submitBtn" class="cl-btn" type="submit">Save new password</button>

        <div class="cl-foot" id="postLinks" style="display:none; margin-top:14px;">
          <a href="/client-login.html">Return to login</a> &nbsp;•&nbsp;
          <a href="/client-dashboard.html">Go to dashboard</a>
        </div>
      </form>
    </section>
  </main>

  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const msg = $('#msg'), form = $('#cpForm'), show = $('#show');
      const emailEl = $('#email'), curEl = $('#current'), nextEl = $('#next'), confEl = $('#confirm');
      const submit = $('#submitBtn'), postLinks = $('#postLinks');

      // Prefill email if they’re logged in via localStorage, but don’t force it.
      document.addEventListener('DOMContentLoaded', ()=>{
        const e = (localStorage.getItem('mfc_email') || localStorage.getItem('mfc_mock_email') || '').toLowerCase();
        if (e) emailEl.value = e;
      });

      show.addEventListener('change', ()=>{
        const type = show.checked ? 'text' : 'password';
        [curEl,nextEl,confEl].forEach(i=> i.type = type);
      });

      function ok(text){ msg.className='cl-msg ok'; msg.textContent=text; }
      function err(text){ msg.className='cl-msg err'; msg.textContent=text; }

      window.__MFC_STORE_READY.then(function(){
        form.addEventListener('submit', function(e){
          e.preventDefault();
          msg.className='cl-msg'; msg.textContent='';
          postLinks.style.display='none';
          submit.disabled = true;

          const email = (emailEl.value||'').trim().toLowerCase();
          const cur   = curEl.value||'';
          const nxt   = nextEl.value||'';
          const cnf   = confEl.value||'';

          if (!email || !cur || !nxt || !cnf){
            err('Please complete all fields.'); submit.disabled=false; return;
          }
          if (nxt !== cnf){ err('New passwords do not match.'); submit.disabled=false; return; }
          // Basic strength guard: ≥ 10 chars and at least 3 of: upper/lower/digit/special
          const classes = [/[A-Z]/.test(nxt), /[a-z]/.test(nxt), /\d/.test(nxt), /[^A-Za-z0-9]/.test(nxt)]
                          .filter(Boolean).length;
          if (nxt.length < 10 || classes < 3){ err('Choose a stronger password (10+ chars, mix of letters, numbers, symbol).'); submit.disabled=false; return; }

          if (!window.MFC_MOCK || !MFC_MOCK.USERS[email]){
            err('No account found for that email.'); submit.disabled=false; return;
          }
          const user = MFC_MOCK.USERS[email];
          if (user.password !== cur){
            err('Current password is incorrect.'); submit.disabled=false; return;
          }

          // ✅ Update in-memory store
          user.password = nxt;

          // Keep session valid if they were logged in
          try{
            if (localStorage.getItem('mfc_email') || localStorage.getItem('mfc_mock_email')){
              const token = 'mock-' + Math.random().toString(36).slice(2);
              localStorage.setItem('mfc_token', token);
              localStorage.setItem('mfc_mock_token', token);
              localStorage.setItem('mfc_email', email);
              localStorage.setItem('mfc_mock_email', email);
            }
          }catch(_){}

          ok('Password updated successfully.');
          postLinks.style.display='block';
          submit.disabled = false;
          curEl.value = nextEl.value = confEl.value = '';
        });
      });
    })();
  </script>
</body>
</html>
