<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Change Password — Maltese First Capital</title>
  <link rel="icon" href="/assets/logo-crest.png">
  <link rel="stylesheet" href="/styles.css" />
  <style>
    html,body{background:#0b0f16;margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,sans-serif}
    .nav{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb}
    .nav-inner{max-width:1160px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;color:#0b0f16;text-decoration:none}
    .brand img{width:44px;height:44px;border-radius:10px;object-fit:contain;background:#0d131b}
    .wrap{max-width:520px;margin:0 auto;padding:24px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:20px;color:#0b0f16;margin-top:24px}
    label{display:block;font-size:.95rem;margin:10px 0 6px;color:#111827}
    input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px}
    .row{display:flex;align-items:center;gap:8px;margin-top:8px}
    .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;width:100%;padding:12px;border-radius:12px;border:1px solid #b38f2e;background:linear-gradient(180deg,#d4af37,#b4912b);color:#111;font-weight:700;margin-top:12px;cursor:pointer}
    .muted{color:#6b7280;font-size:.9rem}
    .err{background:#fff1f2;border:1px solid #fecdd3;color:#7f1d1d;padding:10px;border-radius:12px;margin-bottom:12px;display:none}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:10px;border-radius:12px;margin-bottom:12px;display:none}
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <a class="brand" href="/index.html"><img src="/assets/logo-crest.png" alt=""><b>Maltese First Capital</b></a>
    </div>
  </div>

  <div class="wrap">
    <section class="card">
      <h2 style="margin:0 0 8px">Change Password</h2>
      <p class="muted">Update your password for future logins.</p>

      <div id="okBox" class="ok"></div>
      <div id="errBox" class="err"></div>

      <label>Email</label>
      <input id="email" type="email" placeholder="you@company.com" autocomplete="username" required>

      <label>Current password</label>
      <input id="current" type="password" placeholder="••••••••" autocomplete="current-password" required>

      <label>New password</label>
      <input id="next" type="password" placeholder="Min 8 characters" autocomplete="new-password" required>

      <div class="row">
        <input id="showPwd" type="checkbox" aria-label="Show passwords">
        <span class="muted">Show passwords</span>
      </div>

      <button id="saveBtn" class="btn" type="button">Save password</button>

      <p class="muted" style="margin-top:12px">
        Back to <a class="link" href="/client-login.html">Client Login</a>
      </p>
    </section>
  </div>

  <!-- Shared client store -->
  <script src="/scripts/mock-store.js?v=1"></script>

  <!-- Page logic -->
  <script>
    (()=>{
      const $ = s => document.querySelector(s);
      const ok  = m => { const b=$('#okBox'); const e=$('#errBox'); if(e) e.style.display='none'; if(!b) return; b.textContent=m||''; b.style.display=m?'block':'none'; };
      const err = m => { const b=$('#errBox'); const o=$('#okBox'); if(o) o.style.display='none'; if(!b) return; b.textContent=m||''; b.style.display=m?'block':'none'; };

      $('#showPwd').addEventListener('change',(e)=>{
        ['current','next'].forEach(id => { const f = $('#'+id); if(f) f.type = e.target.checked ? 'text' : 'password'; });
      });

      $('#saveBtn').addEventListener('click', async ()=>{
        ok(''); err('');
        const email = ($('#email').value||'').trim().toLowerCase();
        const cur   = $('#current').value||'';
        const next  = $('#next').value||'';

        if (!email || !cur || !next) return err('All fields are required.');
        if (next.length < 8) return err('New password must be at least 8 characters.');

        const store = window.MFC_MOCK || {};
        const user  = store.USERS?.[email];
        if (!user) return err('No account found.');
        if (user.password !== cur && !store.ALLOW_ANY_PASSWORD) return err('Current password is incorrect.');

        try{
          store.updatePassword(email, next);
          ok('Password updated.');
          // Optional: notify backend (if you added the /api/public/password-changed route)
          try{
            await fetch('/api/public/password-changed',{ method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({ email, changedAt:new Date().toISOString() }) });
          }catch{} // non-fatal
        }catch(e){
          err('Could not update password.');
        }
      });
    })();
  </script>
</body>
</html>
