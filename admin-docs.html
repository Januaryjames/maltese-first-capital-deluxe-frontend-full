<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin • Documents • Maltese First Capital</title>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css?v=30"/>
  <style>
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:16px 0}
    .filters{display:flex;gap:10px;align-items:center}
    .muted{color:#9fb1c7}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    dialog{border:none;border-radius:16px;background:#0f1a27;padding:18px;color:#e6edf5;max-width:560px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .row-actions{display:flex;gap:8px}
    .badge{padding:5px 9px;border-radius:999px;border:1px solid rgba(255,255,255,.08);color:#cfd8e3;font-size:12px}
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar-wrap">
    <div class="container navbar">
      <a class="brand navbar-brand" href="index.html">
        <img src="assets/logo.png" alt="Maltese First Capital"/>
        <span>Maltese First Capital</span>
      </a>
      <nav class="links">
        <a href="admin-dashboard.html">Dashboard</a>
        <a class="highlight" href="admin-docs.html">Documents</a>
        <a href="#" id="logoutLink">Log Out</a>
      </nav>
    </div>
  </div>

  <!-- HERO -->
  <section class="hero">
    <div class="container">
      <img class="hero-logo" src="assets/logo.png" alt="MFC">
      <h1>Client Documents</h1>
      <p class="lead">Review and decide on pending uploads.</p>
    </div>
  </section>

  <main class="section" style="border:none">
    <div class="container">
      <div class="toolbar">
        <div>
          <span class="badge">API: <span class="mono" id="apiHost">unset</span></span>
        </div>
        <div class="filters">
          <input id="fltQ" placeholder="Search email / filename" />
          <button class="btn" id="btnReload">Reload</button>
        </div>
      </div>

      <section class="admin-table">
        <table>
          <thead>
            <tr>
              <th>Uploaded</th>
              <th>Client</th>
              <th>Type</th>
              <th>File</th>
              <th>Status</th>
              <th style="width:280px">Actions</th>
            </tr>
          </thead>
          <tbody id="docsBody"><tr><td class="empty" colspan="6">Loading…</td></tr></tbody>
        </table>
      </section>
    </div>
  </main>

  <footer><div class="container">© 2025 Maltese First Capital — Valletta, Malta</div></footer>

  <dialog id="decisionDlg">
    <form id="decisionForm" method="dialog">
      <h3 id="decisionTitle">Decision</h3>
      <input type="hidden" id="docId">
      <label for="note">Note to client (optional)</label>
      <textarea id="note" rows="4" placeholder="e.g., Please upload a clearer scan…"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" value="cancel">Cancel</button>
        <button class="btn gold" id="decisionSubmit" value="ok">Submit</button>
      </div>
      <div class="muted" id="decisionStatus" style="margin-top:6px"></div>
    </form>
  </dialog>

<script>
const API   = localStorage.getItem('BACKEND_URL') || '';
const token = localStorage.getItem('ADMIN_TOKEN') || '';
document.getElementById('apiHost').textContent = API || 'not set';

document.getElementById('logoutLink').addEventListener('click', (e)=>{
  e.preventDefault();
  localStorage.removeItem('ADMIN_TOKEN');
  location.href='admin-login.html';
});

function hdr(extra={}){ return { 'Accept':'application/json', ...(token?{'Authorization':`Bearer ${token}`}:{}) , ...extra}; }

async function fetchJSON(path, opts={}) {
  const res = await fetch(`${API}${path}`, { ...opts, headers: hdr(opts.headers||{}) });
  if(!res.ok) throw new Error(await res.text());
  try { return await res.json(); } catch { return {}; }
}

function escape(s){return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}
function statusClass(s){ if(s==='approved') return 'complete'; if(s==='rejected') return 'red'; if(s==='review') return 'review'; return 'pending'; }

async function loadDocs(){
  const tbody = document.getElementById('docsBody');
  tbody.innerHTML = `<tr><td class="empty" colspan="6">Loading…</td></tr>`;
  try{
    const data = await fetchJSON(`/api/admin/docs`);
    const docs = (data.docs||[]).filter(Boolean);
    const q = document.getElementById('fltQ').value.trim().toLowerCase();
    const filtered = q ? docs.filter(d =>
      (d.userId?.email||'').toLowerCase().includes(q) ||
      (d.originalName||'').toLowerCase().includes(q)
    ) : docs;

    if(!filtered.length){ tbody.innerHTML = `<tr><td class="empty" colspan="6">No pending documents.</td></tr>`; return; }

    tbody.innerHTML = filtered.map(d=>`
      <tr>
        <td>${new Date(d.createdAt||Date.now()).toLocaleString()}</td>
        <td>
          <div><strong>${escape(d.userId?.email||'Client')}</strong></div>
          <div class="muted mono">${escape(String(d._id||''))}</div>
        </td>
        <td>${escape(d.docType||'—')}</td>
        <td>${d.filename ? `<a class="btn" href="${API}/uploads/${d.filename}" target="_blank" rel="noopener">View</a>` : escape(d.originalName||'file')}</td>
        <td><span class="status ${statusClass(d.status)}">${escape(d.status||'pending')}</span></td>
        <td class="row-actions">
          <button class="btn" data-act="approve" data-id="${d._id}">Approve</button>
          <button class="btn" data-act="reject"  data-id="${d._id}">Reject</button>
        </td>
      </tr>
    `).join('');
  }catch(err){
    tbody.innerHTML = `<tr><td class="empty" colspan="6">Unable to load documents.</td></tr>`;
  }
}

document.getElementById('btnReload').addEventListener('click', loadDocs);

// Decision dialog
const dlg = document.getElementById('decisionDlg');
const form = document.getElementById('decisionForm');
const statusEl = document.getElementById('decisionStatus');
let decisionAction = 'approve';

document.getElementById('docsBody').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act]');
  if(!btn) return;
  decisionAction = btn.dataset.act; // approve or reject
  document.getElementById('docId').value = btn.dataset.id;
  document.getElementById('decisionTitle').textContent = decisionAction === 'approve' ? 'Approve Document' : 'Reject Document';
  document.getElementById('note').value = '';
  statusEl.textContent = '';
  dlg.showModal();
});

document.getElementById('decisionSubmit').addEventListener('click', async (e)=>{
  e.preventDefault();
  statusEl.textContent = 'Submitting…';
  try{
    const id = document.getElementById('docId').value;
    const note = document.getElementById('note').value.trim();
    await fetchJSON(`/api/admin/docs/${encodeURIComponent(id)}/decision`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action: decisionAction, note })
    });
    statusEl.textContent = 'Saved.';
    setTimeout(()=>{ dlg.close(); loadDocs(); }, 600);
  }catch{
    statusEl.textContent = 'Failed to save.';
  }
});

// Go
loadDocs();
</script>
</body>
</html>
