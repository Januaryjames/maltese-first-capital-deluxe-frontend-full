(()=>{const CFG=(window.__MF_CONFIG||{});const API=CFG.API_BASE_URL||"";const SITE_KEY=CFG.TURNSTILE_SITE_KEY||"";const form=document.getElementById('gdpr-form');const status=document.getElementById('gdpr-status');if(!form)return;function loadTurnstile(){return new Promise(r=>{if(window.turnstile)return r(window.turnstile);const s=document.createElement('script');s.src='https://challenges.cloudflare.com/turnstile/v0/api.js';s.async=true;s.defer=true;s.onload=()=>r(window.turnstile||null);document.head.appendChild(s)})}async function getToken(){if(!SITE_KEY)return"";await loadTurnstile();return new Promise(res=>{const div=document.createElement('div');div.style.cssText='position:absolute;width:0;height:0;overflow:hidden;';form.appendChild(div);const wid=window.turnstile.render(div,{sitekey:SITE_KEY,size:'invisible',callback:t=>res(t)});try{window.turnstile.execute(wid)}catch{res("")}})}form.addEventListener('submit',async e=>{e.preventDefault();try{const fd=new FormData(form);const file=fd.get('idDoc');if(file&&file.size){const ok=new Set(['application/pdf','image/jpeg','image/png','image/webp']);if(!ok.has(file.type))throw new Error('Unsupported file type.');if(file.size>5*1024*1024)throw new Error('File too large (max 5MB).')}const token=await getToken();fd.append('cf_turnstile_response',token||'');const res=await fetch(`${API}/api/privacy/dsr`,{method:'POST',body:fd});const txt=await res.text();let data;try{data=txt?JSON.parse(txt):null}catch{data={raw:txt}}if(!res.ok)throw new Error(data?.error||`Failed (${res.status})`);status.textContent=`Request received. ID: ${data.id}`;alert(`Request received. ID: ${data.id}`);try{form.reset()}catch{}}catch(err){alert(err.message||'Submit failed')}})})();